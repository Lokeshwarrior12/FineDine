{"version":3,"names":["Object","defineProperty","exports","value","makeRuntimeShaderImageFilter","makeOffsetImageFilter","makeMorphologyImageFilter","makeDropShadowImageFilter","makeBlurImageFilter","declareDisplacementMapImageFilter","declareBlurMaskFilter","declareBlendImageFilter","MorphologyOperator","_nodes","require","_types","Black","Float32Array","of","MakeInnerShadow","Skia","shadowOnly","dx","dy","sigmaX","sigmaY","color","input","sourceGraphic","ImageFilter","MakeColorFilter","ColorFilter","MakeBlend","BlendMode","Dst","sourceAlpha","SrcIn","f1","SrcOut","f2","MakeOffset","f3","MakeBlur","TileMode","Decal","f4","MakeCompose","SrcOver","ctx","_ctx$imageFilters$pop","imageFilters","pop","props","x","y","channelX","channelY","scale","shader","shaders","Error","map","MakeShader","imgf","MakeDisplacementMap","ColorChannel","enumKey","push","mode","blur","sigma","processRadius","cl","inner","Color","factory","bind","MakeDropShadowOnly","MakeDropShadow","operator","r","radius","Erode","MakeErode","MakeDilate","source","uniforms","rtb","RuntimeShaderBuilder","processUniforms","MakeRuntimeShader","a","b","style","respectCTM","mf","MaskFilter","BlurStyle","maskFilters"],"sources":["imageFilters.ts"],"sourcesContent":["\"worklet\";\n\nimport { enumKey, processRadius } from \"../../dom/nodes\";\nimport type {\n  BlendImageFilterProps,\n  BlurImageFilterProps,\n  BlurMaskFilterProps,\n  DeclarationContext,\n  DisplacementMapImageFilterProps,\n  DropShadowImageFilterProps,\n  MorphologyImageFilterProps,\n  OffsetImageFilterProps,\n  RuntimeShaderImageFilterProps,\n} from \"../../dom/types\";\nimport type { SkColor, Skia, SkImageFilter } from \"../../skia/types\";\nimport {\n  BlendMode,\n  BlurStyle,\n  ColorChannel,\n  processUniforms,\n  TileMode,\n} from \"../../skia/types\";\n\nexport enum MorphologyOperator {\n  Erode,\n  Dilate,\n}\n\nconst Black = Float32Array.of(0, 0, 0, 1);\n\nconst MakeInnerShadow = (\n  Skia: Skia,\n  shadowOnly: boolean | undefined,\n  dx: number,\n  dy: number,\n  sigmaX: number,\n  sigmaY: number,\n  color: SkColor,\n  input: SkImageFilter | null\n) => {\n  const sourceGraphic = Skia.ImageFilter.MakeColorFilter(\n    Skia.ColorFilter.MakeBlend(Black, BlendMode.Dst),\n    null\n  );\n  const sourceAlpha = Skia.ImageFilter.MakeColorFilter(\n    Skia.ColorFilter.MakeBlend(Black, BlendMode.SrcIn),\n    null\n  );\n  const f1 = Skia.ImageFilter.MakeColorFilter(\n    Skia.ColorFilter.MakeBlend(color, BlendMode.SrcOut),\n    null\n  );\n  const f2 = Skia.ImageFilter.MakeOffset(dx, dy, f1);\n  const f3 = Skia.ImageFilter.MakeBlur(sigmaX, sigmaY, TileMode.Decal, f2);\n  const f4 = Skia.ImageFilter.MakeBlend(BlendMode.SrcIn, sourceAlpha, f3);\n  if (shadowOnly) {\n    return f4;\n  }\n  return Skia.ImageFilter.MakeCompose(\n    input,\n    Skia.ImageFilter.MakeBlend(BlendMode.SrcOver, sourceGraphic, f4)\n  );\n};\n\nconst input = (ctx: DeclarationContext) => {\n  return ctx.imageFilters.pop() ?? null;\n};\n\nexport const makeOffsetImageFilter = (\n  ctx: DeclarationContext,\n  props: OffsetImageFilterProps\n) => {\n  const { x, y } = props;\n  return ctx.Skia.ImageFilter.MakeOffset(x, y, null);\n};\n\nexport const declareDisplacementMapImageFilter = (\n  ctx: DeclarationContext,\n  props: DisplacementMapImageFilterProps\n) => {\n  const { channelX, channelY, scale } = props;\n  const shader = ctx.shaders.pop();\n  if (!shader) {\n    throw new Error(\"DisplacementMap expects a shader as child\");\n  }\n  const map = ctx.Skia.ImageFilter.MakeShader(shader, null);\n  const imgf = ctx.Skia.ImageFilter.MakeDisplacementMap(\n    ColorChannel[enumKey(channelX)],\n    ColorChannel[enumKey(channelY)],\n    scale,\n    map,\n    input(ctx)\n  );\n  ctx.imageFilters.push(imgf);\n};\n\nexport const makeBlurImageFilter = (\n  ctx: DeclarationContext,\n  props: BlurImageFilterProps\n) => {\n  const { mode, blur } = props;\n  const sigma = processRadius(ctx.Skia, blur);\n  const imgf = ctx.Skia.ImageFilter.MakeBlur(\n    sigma.x,\n    sigma.y,\n    TileMode[enumKey(mode)],\n    input(ctx)\n  );\n  return imgf;\n};\n\nexport const makeDropShadowImageFilter = (\n  ctx: DeclarationContext,\n  props: DropShadowImageFilterProps\n) => {\n  const { dx, dy, blur, shadowOnly, color: cl, inner } = props;\n  const color = ctx.Skia.Color(cl);\n  let factory;\n  if (inner) {\n    factory = MakeInnerShadow.bind(null, ctx.Skia, shadowOnly);\n  } else {\n    factory = shadowOnly\n      ? ctx.Skia.ImageFilter.MakeDropShadowOnly.bind(ctx.Skia.ImageFilter)\n      : ctx.Skia.ImageFilter.MakeDropShadow.bind(ctx.Skia.ImageFilter);\n  }\n  const imgf = factory(dx, dy, blur, blur, color, input(ctx));\n  return imgf;\n};\n\nexport const makeMorphologyImageFilter = (\n  ctx: DeclarationContext,\n  props: MorphologyImageFilterProps\n) => {\n  const { operator } = props;\n  const r = processRadius(ctx.Skia, props.radius);\n  let imgf;\n  if (MorphologyOperator[enumKey(operator)] === MorphologyOperator.Erode) {\n    imgf = ctx.Skia.ImageFilter.MakeErode(r.x, r.y, input(ctx));\n  } else {\n    imgf = ctx.Skia.ImageFilter.MakeDilate(r.x, r.y, input(ctx));\n  }\n  return imgf;\n};\n\nexport const makeRuntimeShaderImageFilter = (\n  ctx: DeclarationContext,\n  props: RuntimeShaderImageFilterProps\n) => {\n  const { source, uniforms } = props;\n  const rtb = ctx.Skia.RuntimeShaderBuilder(source);\n  if (uniforms) {\n    processUniforms(source, uniforms, rtb);\n  }\n  const imgf = ctx.Skia.ImageFilter.MakeRuntimeShader(rtb, null, input(ctx));\n  return imgf;\n};\n\nexport const declareBlendImageFilter = (\n  ctx: DeclarationContext,\n  props: BlendImageFilterProps\n) => {\n  const { mode } = props;\n  const a = ctx.imageFilters.pop();\n  const b = ctx.imageFilters.pop();\n  if (!a || !b) {\n    throw new Error(\"BlendImageFilter requires two image filters\");\n  }\n  const imgf = ctx.Skia.ImageFilter.MakeBlend(mode, a, b);\n  ctx.imageFilters.push(imgf);\n};\n\nexport const declareBlurMaskFilter = (\n  ctx: DeclarationContext,\n  props: BlurMaskFilterProps\n) => {\n  const { blur, style, respectCTM } = props;\n  const mf = ctx.Skia.MaskFilter.MakeBlur(\n    BlurStyle[enumKey(style)],\n    blur,\n    respectCTM\n  );\n  ctx.maskFilters.push(mf);\n};\n"],"mappings":"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","ignoreList":[]}