{"version":3,"names":["Object","defineProperty","exports","value","DrawingContext","_nodes","require","_types","_types2","_defineProperty","e","r","t","_toPropertyKey","enumerable","configurable","writable","i","_toPrimitive","Symbol","toPrimitive","call","TypeError","String","Number","computeClip","Skia","clip","isPathDef","clipPath","processPath","isRRect","clipRRect","clipRect","undefined","constructor","canvas","paints","Paint","declCtx","DeclarationContext","save","push","paint","copy","restore","pop","length","Error","getLocalPaints","popAll","processPaint","opacity","color","strokeWidth","blendMode","style","strokeJoin","strokeCap","strokeMiter","antiAlias","dither","paintProp","shouldRestore","colorFilter","colorFilters","popAllAsOne","imageFilter","imageFilters","shader","shaders","maskFilter","maskFilters","pathEffect","pathEffects","setAlphaf","getAlphaf","currentOpacity","setShader","setColor","Color","Array","isArray","Float32Array","setStrokeWidth","setBlendMode","BlendMode","enumKey","setStyle","PaintStyle","setStrokeJoin","StrokeJoin","setStrokeCap","StrokeCap","setStrokeMiter","setAntiAlias","setDither","setColorFilter","setImageFilter","setMaskFilter","setPathEffect","processMatrixAndClipping","props","layer","hasTransform","matrix","transform","hasClip","op","invertClip","ClipOp","Difference","Intersect","m3","processTransformProps2","shouldSave","saveLayer","concat"],"sources":["DrawingContext.ts"],"sourcesContent":["\"worklet\";\n\nimport {\n  enumKey,\n  isPathDef,\n  processPath,\n  processTransformProps2,\n} from \"../dom/nodes\";\nimport type { ClipDef, DrawingNodeProps, GroupProps } from \"../dom/types\";\nimport { DeclarationContext } from \"../dom/types\";\nimport {\n  BlendMode,\n  ClipOp,\n  isRRect,\n  PaintStyle,\n  StrokeCap,\n  StrokeJoin,\n} from \"../skia/types\";\nimport type {\n  SkPath,\n  SkRect,\n  SkRRect,\n  SkCanvas,\n  Skia,\n  SkPaint,\n} from \"../skia/types\";\n\nconst computeClip = (\n  Skia: Skia,\n  clip: ClipDef | undefined\n):\n  | undefined\n  | { clipPath: SkPath }\n  | { clipRect: SkRect }\n  | { clipRRect: SkRRect } => {\n  if (clip) {\n    if (isPathDef(clip)) {\n      return { clipPath: processPath(Skia, clip) };\n    } else if (isRRect(clip)) {\n      return { clipRRect: clip };\n    } else {\n      return { clipRect: clip };\n    }\n  }\n  return undefined;\n};\n\nexport class DrawingContext {\n  private paints: SkPaint[];\n  public declCtx: DeclarationContext;\n  public Skia: Skia;\n  public canvas: SkCanvas;\n\n  constructor(Skia: Skia, canvas: SkCanvas) {\n    this.Skia = Skia;\n    this.canvas = canvas;\n    this.paints = [Skia.Paint()];\n    this.declCtx = new DeclarationContext(this.Skia);\n  }\n\n  save() {\n    this.paints.push(this.paint.copy());\n  }\n\n  restore() {\n    this.paints.pop();\n  }\n\n  get paint() {\n    const paint = this.paints[this.paints.length - 1];\n    if (!paint) {\n      throw new Error(\"Paint is undefined\");\n    }\n    return paint;\n  }\n\n  getLocalPaints() {\n    const { paint } = this;\n    return [paint, ...this.declCtx.paints.popAll()];\n  }\n\n  processPaint({\n    opacity,\n    color,\n    strokeWidth,\n    blendMode,\n    style,\n    strokeJoin,\n    strokeCap,\n    strokeMiter,\n    antiAlias,\n    dither,\n    paint: paintProp,\n  }: DrawingNodeProps) {\n    if (paintProp) {\n      this.declCtx.paints.push(paintProp);\n      return true;\n    }\n    let shouldRestore = false;\n    const colorFilter = this.declCtx.colorFilters.popAllAsOne();\n    const imageFilter = this.declCtx.imageFilters.popAllAsOne();\n    const shader = this.declCtx.shaders.pop();\n    const maskFilter = this.declCtx.maskFilters.pop();\n    const pathEffect = this.declCtx.pathEffects.popAllAsOne();\n    if (\n      opacity !== undefined ||\n      color !== undefined ||\n      strokeWidth !== undefined ||\n      blendMode !== undefined ||\n      style !== undefined ||\n      strokeJoin !== undefined ||\n      strokeCap !== undefined ||\n      strokeMiter !== undefined ||\n      antiAlias !== undefined ||\n      dither !== undefined ||\n      colorFilter !== undefined ||\n      imageFilter !== undefined ||\n      shader !== undefined ||\n      maskFilter !== undefined ||\n      pathEffect !== undefined\n    ) {\n      if (!shouldRestore) {\n        this.save();\n        shouldRestore = true;\n      }\n    }\n    const { paint } = this;\n    if (opacity !== undefined) {\n      paint.setAlphaf(paint.getAlphaf() * opacity);\n    }\n    if (color !== undefined) {\n      const currentOpacity = paint.getAlphaf();\n      paint.setShader(null);\n      if (typeof color === \"string\" || typeof color === \"number\") {\n        paint.setColor(this.Skia.Color(color));\n      } else if (Array.isArray(color)) {\n        paint.setColor(new Float32Array(color));\n      } else if (color instanceof Float32Array) {\n        paint.setColor(color);\n      } else {\n        throw new Error(\"Invalid color\");\n      }\n      paint.setAlphaf(currentOpacity * paint.getAlphaf());\n    }\n    if (strokeWidth !== undefined) {\n      paint.setStrokeWidth(strokeWidth);\n    }\n    if (blendMode !== undefined) {\n      paint.setBlendMode(BlendMode[enumKey(blendMode)]);\n    }\n    if (style !== undefined) {\n      paint.setStyle(PaintStyle[enumKey(style)]);\n    }\n    if (strokeJoin !== undefined) {\n      paint.setStrokeJoin(StrokeJoin[enumKey(strokeJoin)]);\n    }\n    if (strokeCap !== undefined) {\n      paint.setStrokeCap(StrokeCap[enumKey(strokeCap)]);\n    }\n    if (strokeMiter !== undefined) {\n      paint.setStrokeMiter(strokeMiter);\n    }\n    if (antiAlias !== undefined) {\n      paint.setAntiAlias(antiAlias);\n    }\n    if (dither !== undefined) {\n      paint.setDither(dither);\n    }\n    if (colorFilter) {\n      paint.setColorFilter(colorFilter);\n    }\n    if (imageFilter) {\n      paint.setImageFilter(imageFilter);\n    }\n    if (shader) {\n      paint.setShader(shader);\n    }\n    if (maskFilter) {\n      paint.setMaskFilter(maskFilter);\n    }\n    if (pathEffect) {\n      paint.setPathEffect(pathEffect);\n    }\n    return shouldRestore;\n  }\n\n  processMatrixAndClipping(props: GroupProps, layer?: boolean | SkPaint) {\n    const hasTransform =\n      props.matrix !== undefined || props.transform !== undefined;\n    const clip = computeClip(this.Skia, props.clip);\n    const hasClip = clip !== undefined;\n    const op = props.invertClip ? ClipOp.Difference : ClipOp.Intersect;\n    const m3 = processTransformProps2(this.Skia, props);\n    const shouldSave = hasTransform || hasClip || !!layer;\n    if (shouldSave) {\n      if (layer) {\n        if (typeof layer === \"boolean\") {\n          this.canvas.saveLayer();\n        } else {\n          this.canvas.saveLayer(layer);\n        }\n      } else {\n        this.canvas.save();\n      }\n    }\n\n    if (m3) {\n      this.canvas.concat(m3);\n    }\n    if (clip) {\n      if (\"clipRect\" in clip) {\n        this.canvas.clipRect(clip.clipRect, op, true);\n      } else if (\"clipRRect\" in clip) {\n        this.canvas.clipRRect(clip.clipRRect, op, true);\n      } else {\n        this.canvas.clipPath(clip.clipPath, op, true);\n      }\n    }\n    return shouldSave;\n  }\n}\n"],"mappings":"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","ignoreList":[]}