{"version":3,"names":["enumKey","processRadius","BlendMode","BlurStyle","ColorChannel","processUniforms","TileMode","MorphologyOperator","Black","Float32Array","of","MakeInnerShadow","Skia","shadowOnly","dx","dy","sigmaX","sigmaY","color","input","sourceGraphic","ImageFilter","MakeColorFilter","ColorFilter","MakeBlend","Dst","sourceAlpha","SrcIn","f1","SrcOut","f2","MakeOffset","f3","MakeBlur","Decal","f4","MakeCompose","SrcOver","ctx","_ctx$imageFilters$pop","imageFilters","pop","makeOffsetImageFilter","props","x","y","declareDisplacementMapImageFilter","channelX","channelY","scale","shader","shaders","Error","map","MakeShader","imgf","MakeDisplacementMap","push","makeBlurImageFilter","mode","blur","sigma","makeDropShadowImageFilter","cl","inner","Color","factory","bind","MakeDropShadowOnly","MakeDropShadow","makeMorphologyImageFilter","operator","r","radius","Erode","MakeErode","MakeDilate","makeRuntimeShaderImageFilter","source","uniforms","rtb","RuntimeShaderBuilder","MakeRuntimeShader","declareBlendImageFilter","a","b","declareBlurMaskFilter","style","respectCTM","mf","MaskFilter","maskFilters"],"sources":["imageFilters.ts"],"sourcesContent":["\"worklet\";\n\nimport { enumKey, processRadius } from \"../../dom/nodes\";\nimport type {\n  BlendImageFilterProps,\n  BlurImageFilterProps,\n  BlurMaskFilterProps,\n  DeclarationContext,\n  DisplacementMapImageFilterProps,\n  DropShadowImageFilterProps,\n  MorphologyImageFilterProps,\n  OffsetImageFilterProps,\n  RuntimeShaderImageFilterProps,\n} from \"../../dom/types\";\nimport type { SkColor, Skia, SkImageFilter } from \"../../skia/types\";\nimport {\n  BlendMode,\n  BlurStyle,\n  ColorChannel,\n  processUniforms,\n  TileMode,\n} from \"../../skia/types\";\n\nexport enum MorphologyOperator {\n  Erode,\n  Dilate,\n}\n\nconst Black = Float32Array.of(0, 0, 0, 1);\n\nconst MakeInnerShadow = (\n  Skia: Skia,\n  shadowOnly: boolean | undefined,\n  dx: number,\n  dy: number,\n  sigmaX: number,\n  sigmaY: number,\n  color: SkColor,\n  input: SkImageFilter | null\n) => {\n  const sourceGraphic = Skia.ImageFilter.MakeColorFilter(\n    Skia.ColorFilter.MakeBlend(Black, BlendMode.Dst),\n    null\n  );\n  const sourceAlpha = Skia.ImageFilter.MakeColorFilter(\n    Skia.ColorFilter.MakeBlend(Black, BlendMode.SrcIn),\n    null\n  );\n  const f1 = Skia.ImageFilter.MakeColorFilter(\n    Skia.ColorFilter.MakeBlend(color, BlendMode.SrcOut),\n    null\n  );\n  const f2 = Skia.ImageFilter.MakeOffset(dx, dy, f1);\n  const f3 = Skia.ImageFilter.MakeBlur(sigmaX, sigmaY, TileMode.Decal, f2);\n  const f4 = Skia.ImageFilter.MakeBlend(BlendMode.SrcIn, sourceAlpha, f3);\n  if (shadowOnly) {\n    return f4;\n  }\n  return Skia.ImageFilter.MakeCompose(\n    input,\n    Skia.ImageFilter.MakeBlend(BlendMode.SrcOver, sourceGraphic, f4)\n  );\n};\n\nconst input = (ctx: DeclarationContext) => {\n  return ctx.imageFilters.pop() ?? null;\n};\n\nexport const makeOffsetImageFilter = (\n  ctx: DeclarationContext,\n  props: OffsetImageFilterProps\n) => {\n  const { x, y } = props;\n  return ctx.Skia.ImageFilter.MakeOffset(x, y, null);\n};\n\nexport const declareDisplacementMapImageFilter = (\n  ctx: DeclarationContext,\n  props: DisplacementMapImageFilterProps\n) => {\n  const { channelX, channelY, scale } = props;\n  const shader = ctx.shaders.pop();\n  if (!shader) {\n    throw new Error(\"DisplacementMap expects a shader as child\");\n  }\n  const map = ctx.Skia.ImageFilter.MakeShader(shader, null);\n  const imgf = ctx.Skia.ImageFilter.MakeDisplacementMap(\n    ColorChannel[enumKey(channelX)],\n    ColorChannel[enumKey(channelY)],\n    scale,\n    map,\n    input(ctx)\n  );\n  ctx.imageFilters.push(imgf);\n};\n\nexport const makeBlurImageFilter = (\n  ctx: DeclarationContext,\n  props: BlurImageFilterProps\n) => {\n  const { mode, blur } = props;\n  const sigma = processRadius(ctx.Skia, blur);\n  const imgf = ctx.Skia.ImageFilter.MakeBlur(\n    sigma.x,\n    sigma.y,\n    TileMode[enumKey(mode)],\n    input(ctx)\n  );\n  return imgf;\n};\n\nexport const makeDropShadowImageFilter = (\n  ctx: DeclarationContext,\n  props: DropShadowImageFilterProps\n) => {\n  const { dx, dy, blur, shadowOnly, color: cl, inner } = props;\n  const color = ctx.Skia.Color(cl);\n  let factory;\n  if (inner) {\n    factory = MakeInnerShadow.bind(null, ctx.Skia, shadowOnly);\n  } else {\n    factory = shadowOnly\n      ? ctx.Skia.ImageFilter.MakeDropShadowOnly.bind(ctx.Skia.ImageFilter)\n      : ctx.Skia.ImageFilter.MakeDropShadow.bind(ctx.Skia.ImageFilter);\n  }\n  const imgf = factory(dx, dy, blur, blur, color, input(ctx));\n  return imgf;\n};\n\nexport const makeMorphologyImageFilter = (\n  ctx: DeclarationContext,\n  props: MorphologyImageFilterProps\n) => {\n  const { operator } = props;\n  const r = processRadius(ctx.Skia, props.radius);\n  let imgf;\n  if (MorphologyOperator[enumKey(operator)] === MorphologyOperator.Erode) {\n    imgf = ctx.Skia.ImageFilter.MakeErode(r.x, r.y, input(ctx));\n  } else {\n    imgf = ctx.Skia.ImageFilter.MakeDilate(r.x, r.y, input(ctx));\n  }\n  return imgf;\n};\n\nexport const makeRuntimeShaderImageFilter = (\n  ctx: DeclarationContext,\n  props: RuntimeShaderImageFilterProps\n) => {\n  const { source, uniforms } = props;\n  const rtb = ctx.Skia.RuntimeShaderBuilder(source);\n  if (uniforms) {\n    processUniforms(source, uniforms, rtb);\n  }\n  const imgf = ctx.Skia.ImageFilter.MakeRuntimeShader(rtb, null, input(ctx));\n  return imgf;\n};\n\nexport const declareBlendImageFilter = (\n  ctx: DeclarationContext,\n  props: BlendImageFilterProps\n) => {\n  const { mode } = props;\n  const a = ctx.imageFilters.pop();\n  const b = ctx.imageFilters.pop();\n  if (!a || !b) {\n    throw new Error(\"BlendImageFilter requires two image filters\");\n  }\n  const imgf = ctx.Skia.ImageFilter.MakeBlend(mode, a, b);\n  ctx.imageFilters.push(imgf);\n};\n\nexport const declareBlurMaskFilter = (\n  ctx: DeclarationContext,\n  props: BlurMaskFilterProps\n) => {\n  const { blur, style, respectCTM } = props;\n  const mf = ctx.Skia.MaskFilter.MakeBlur(\n    BlurStyle[enumKey(style)],\n    blur,\n    respectCTM\n  );\n  ctx.maskFilters.push(mf);\n};\n"],"mappings":"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","ignoreList":[]}